# Regression Test ‚Äî Ensure Akinator Accuracy Stays >= 99%
#
# This workflow runs on every push and PR to ensure
# that code changes don't degrade the guessing accuracy.

name: Accuracy Regression Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  accuracy-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-asyncio aiosqlite numpy

    - name: Verify database exists
      run: |
        if [ ! -f "data/akinator.db" ]; then
          echo "‚ùå Database not found! Copying from bundled DB..."
          cp akinator/data/akinator.db data/akinator.db
        fi
        echo "‚úÖ Database verified"

    - name: Run Simulation Test (Accuracy >= 99% required)
      run: |
        echo "üéØ Running accuracy regression test..."
        pytest tests/test_simulation.py::test_full_simulation -v -s
        echo "‚úÖ Test passed! Accuracy >= 99%"

    - name: Report Results
      if: always()
      run: |
        if [ -f "memory/SIMULATION_RESULTS.md" ]; then
          echo "üìä Latest results appended to memory/SIMULATION_RESULTS.md"
          tail -20 memory/SIMULATION_RESULTS.md
        fi

    - name: Fail on accuracy regression
      if: failure()
      run: |
        echo "‚ùå ACCURACY REGRESSION DETECTED!"
        echo ""
        echo "The guessing accuracy has dropped below 99%."
        echo "This indicates a problem with:"
        echo "  - Attribute changes in categories.py"
        echo "  - Missing entity overrides in entity_to_category_map.py"
        echo "  - Database corruption or regeneration"
        echo "  - Algorithm changes in engine/"
        echo ""
        echo "See tests/README_REGRESSION_TEST.md for debugging steps."
        exit 1
